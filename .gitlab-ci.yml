variables:
  UPSTREAM_GITLAB_BASE_URL: "https://gitlab.com"

workflow:
  rules:
    - if: $CI_PIPELINE_SOURCE == "trigger"
    - if: $CI_PIPELINE_SOURCE == "pipeline"
    - when: never

stages:
  - implement
  - test

# 测试 project_understanding 模块（通过 TRIGGER_TYPE 触发）
test_project_understanding:
  stage: test
  tags:
    - k8s
    - copilot
  rules:
    - if: $TRIGGER_TYPE == "test_project_understanding"
  image: satomic/copilot-cli:latest
  script:
    - copilot --version
    - cd index_repo/src
    - python -m project_understanding.cli --no-cache -v
    - cat .copilot/context.md
  artifacts:
    paths:
      - index_repo/src/.copilot/

# Job for issue assignee workflow (optimized single job)
issue_workflow:
  stage: implement
  tags:
    - k8s
    - copilot
  rules:
    - if: $TRIGGER_TYPE == "issue_assignee"
  image: satomic/copilot-cli:latest
  script:
    - copilot --version
    - export REPO_DIR="repo-${TARGET_PROJECT_ID}"
    - bash scripts/issue_workflow.sh
  artifacts:
    paths:
      - todo.md
      - todo_completed.md
      - mr.json
      - repo-*/todo_completed.md
      - repo-*/patch_raw.txt
      - repo-*/copilot.patch

# Job for MR note workflow
mr_update:
  stage: implement
  tags:
    - k8s
    - copilot
  rules:
    - if: $TRIGGER_TYPE == "mr_note"
  image: satomic/copilot-cli:latest
  script:
    - copilot --version
    - export REPO_DIR="repo-${TARGET_PROJECT_ID}"
    - bash scripts/mr_update.sh
  artifacts:
    paths:
      - repo-*/patch_raw.txt

# Job for MR reviewer workflow
mr_review:
  stage: implement
  tags:
    - k8s
    - copilot
  rules:
    - if: $TRIGGER_TYPE == "mr_reviewer"
  image: satomic/copilot-cli:latest
  variables:
    ENABLE_PROJECT_UNDERSTANDING: "${ENABLE_PROJECT_UNDERSTANDING:-true}"
    AZURE_STORAGE_CONNECTION_STRING: "${AZURE_STORAGE_CONNECTION_STRING}"
  script:
    - copilot --version
    - |
      # 调试 GITHUB_TOKEN
      echo "[DEBUG] GITHUB_TOKEN length: ${#GITHUB_TOKEN}"
      echo "[DEBUG] GITHUB_TOKEN prefix: ${GITHUB_TOKEN:0:20}..."
      
      # 测试 copilot 是否能正常工作
      echo "[DEBUG] Testing copilot with simple prompt..."
      echo "Reply with only: OK" | copilot 2>&1
      COPILOT_EXIT=$?
      echo "[DEBUG] Copilot exit code: ${COPILOT_EXIT}"
      
      if [ "${COPILOT_EXIT}" -ne 0 ]; then
        echo "[ERROR] Copilot failed in CI environment!"
        echo "[DEBUG] Checking node version..."
        node --version || echo "node not found"
        echo "[DEBUG] Checking npm version..."
        npm --version || echo "npm not found"
        echo "[DEBUG] Environment variables related to GitHub:"
        env | grep -i github || echo "No GITHUB env vars"
        env | grep -i gh_ || echo "No GH_ env vars"
      fi
      
      # 使用项目ID作为目录名（避免不同项目冲突）
      REPO_DIR="repo-${TARGET_PROJECT_ID}"
      echo "[INFO] Using repository directory: ${REPO_DIR}"
      
      # 运行项目理解分析（如果启用）
      if [ "${ENABLE_PROJECT_UNDERSTANDING}" = "true" ]; then
        echo "[INFO] Running project understanding analysis on target repo..."
        
        # 调试：打印关键变量
        echo "[DEBUG] UPSTREAM_PROJECT_PATH: ${UPSTREAM_PROJECT_PATH}"
        echo "[DEBUG] UPSTREAM_GITLAB_BASE_URL: ${UPSTREAM_GITLAB_BASE_URL}"
        echo "[DEBUG] TARGET_PROJECT_ID: ${TARGET_PROJECT_ID}"
        echo "[DEBUG] TARGET_BRANCH: ${TARGET_BRANCH}"
        
        # 检查必要变量
        if [ -z "${UPSTREAM_PROJECT_PATH}" ]; then
          echo "[ERROR] UPSTREAM_PROJECT_PATH is not set, skipping project understanding"
          export ENABLE_PROJECT_UNDERSTANDING=false
        else
          # 克隆目标仓库到项目特定目录
          # 使用 GITLAB_TOKEN（webhook 传递的标准 token）
          # URL encode token 以处理特殊字符
          ENCODED_TOKEN=$(python3 -c "import urllib.parse; print(urllib.parse.quote('${GITLAB_TOKEN}', safe=''))")
          CLONE_URL="https://oauth2:${ENCODED_TOKEN}@${UPSTREAM_GITLAB_BASE_URL#https://}/${UPSTREAM_PROJECT_PATH}.git"
          echo "[INFO] Cloning from: https://oauth2:***@${UPSTREAM_GITLAB_BASE_URL#https://}/${UPSTREAM_PROJECT_PATH}.git"
          
          git clone "${CLONE_URL}" "${REPO_DIR}" || {
            echo "[ERROR] Failed to clone repository, skipping project understanding"
            export ENABLE_PROJECT_UNDERSTANDING=false
          }
        fi
      fi
      
      # 如果克隆成功，继续项目理解分析
      if [ "${ENABLE_PROJECT_UNDERSTANDING}" = "true" ] && [ -d "${REPO_DIR}" ]; then
        cd "${REPO_DIR}"
        export CI_COMMIT_SHA=$(git rev-parse HEAD)
        export CI_COMMIT_BEFORE_SHA=$(git rev-parse HEAD~1 2>/dev/null || echo "0000000000000000000000000000000000000000")
        git checkout "${TARGET_BRANCH:-main}" 2>/dev/null || echo "[WARN] Could not checkout ${TARGET_BRANCH:-main}"
        cd ..
        
        # 使用新的智能上下文管理器（Phase 6 集成）
        # 注意：必须在主仓库根目录运行，Copilot CLI 认证与当前 git 仓库绑定
        if [ -n "${AZURE_STORAGE_CONNECTION_STRING}" ]; then
          echo "[INFO] Using intelligent context manager with 5-level cache strategy..."
          bash scripts/ci_context_manager.sh || {
            echo "[WARN] Context manager failed, falling back to legacy mode"
            
            # Fallback: 在根目录运行（不要 cd 到 index_repo/src）
            export PYTHONPATH="${PWD}/index_repo/src:${PYTHONPATH:-}"
            python3 -m project_understanding.cli "${REPO_DIR}" --output-dir "${REPO_DIR}/.copilot" --output-file project_context.md --no-cache --timeout 3600 -v || echo "[WARN] Project understanding failed, continuing..."
          }
        else
          # 无 Azure 连接时，直接执行完整分析
          echo "[INFO] Azure Blob Storage not configured, running full analysis..."
          export PYTHONPATH="${PWD}/index_repo/src:${PYTHONPATH:-}"
          python3 -m project_understanding.cli "${REPO_DIR}" --output-dir "${REPO_DIR}/.copilot" --output-file project_context.md --no-cache --timeout 3600 -v || echo "[WARN] Project understanding failed, continuing..."
        fi
        
        echo "[INFO] Project understanding completed for ${REPO_DIR}"
      fi
      
      # 传递目录名给 review 脚本
      export REPO_DIR="${REPO_DIR}"
      export SKIP_REPO_CLONE="${ENABLE_PROJECT_UNDERSTANDING}"
      

      
      # 执行 MR review
      if [ "${USE_ORCHESTRATED_REVIEW:-false}" = "true" ]; then
        echo "[INFO] Using orchestrated review mode (task framework)"
        bash scripts/mr_review_orchestrated.sh
      elif [ "${ENABLE_INLINE_REVIEW_COMMENTS:-false}" = "true" ]; then
        echo "[INFO] Using inline comments mode"
        bash scripts/mr_review_with_inline_comments.sh
      else
        echo "[INFO] Using general comments mode"
        bash scripts/mr_review.sh
      fi
  artifacts:
    when: always
    paths:
      - repo-*/task_plan.json
      - repo-*/review_results.json
      - repo-*/review_summary.md
      - repo-*/full_diff.txt
      - repo-*/review_comment.txt
      - repo-*/review_raw.txt
      - repo-*/review_summary.txt
      - repo-*/review_findings.json
      - repo-*/.copilot/
