variables:
  UPSTREAM_GITLAB_BASE_URL: "https://gitlab.com"

workflow:
  rules:
    - if: $CI_PIPELINE_SOURCE == "trigger"
    - if: $CI_PIPELINE_SOURCE == "pipeline"
    - when: never

stages:
  - implement
  - test

# 测试 project_understanding 模块（通过 TRIGGER_TYPE 触发）
test_project_understanding:
  stage: test
  tags:
    - k8s
    - copilot
  rules:
    - if: $TRIGGER_TYPE == "test_project_understanding"
  image: nikadwang.azurecr.io/copilot-runner:v0.0.5
  script:
    - copilot --version
    - cd index_repo/src
    - python -m project_understanding.cli --no-cache -v
    - cat .copilot/context.md
  artifacts:
    paths:
      - index_repo/src/.copilot/

# Job for issue assignee workflow (optimized single job)
issue_workflow:
  stage: implement
  tags:
    - k8s
    - copilot
  rules:
    - if: $TRIGGER_TYPE == "issue_assignee" && $USE_ORCHESTRATED_ISSUE != "true"
  image: nikadwang.azurecr.io/copilot-runner:v0.0.5
  script:
    - copilot --version
    - export REPO_DIR="repo-${TARGET_PROJECT_ID}"
    - bash scripts/issue_workflow.sh
  artifacts:
    paths:
      - todo.md
      - todo_completed.md
      - mr.json
      - repo-*/todo_completed.md
      - repo-*/patch_raw.txt
      - repo-*/copilot.patch

# Job for orchestrated issue workflow (with project understanding)
issue_workflow_orchestrated:
  stage: implement
  tags:
    - k8s
    - copilot
  rules:
    - if: $TRIGGER_TYPE == "issue_assignee" && $USE_ORCHESTRATED_ISSUE == "true"
  image: nikadwang.azurecr.io/copilot-runner:v0.0.5
  # Note: AZURE_STORAGE_CONNECTION_STRING is passed from webhook trigger
  script:
    - copilot --version
    - export REPO_DIR="repo-${TARGET_PROJECT_ID}"
    - bash scripts/issue_workflow_orchestrated.sh
  artifacts:
    when: always
    paths:
      - issue_plan.json
      - execution_results.json
      - mr.json
      - repo-*/.copilot/
      - repo-*/.copilot_tasks/

# Job for Issue note mention workflow (triggered by @copilot in Issue comments)
issue_note_workflow:
  stage: implement
  tags:
    - k8s
    - copilot
  rules:
    - if: $TRIGGER_TYPE == "issue_note"
  image: nikadwang.azurecr.io/copilot-runner:v0.0.5
  # Note: AZURE_STORAGE_CONNECTION_STRING is passed from webhook trigger
  script:
    - copilot --version
    - export REPO_DIR="repo-${TARGET_PROJECT_ID}"
    - bash scripts/issue_note_workflow.sh
  artifacts:
    when: always
    paths:
      - mr.json
      - mr_description.txt
      - copilot_output.log
      - repo-*/.copilot/
      - implementation_prompt.txt

# Job for MR note workflow (legacy single-stage)
mr_update:
  stage: implement
  tags:
    - k8s
    - copilot
  rules:
    - if: $TRIGGER_TYPE == "mr_note" && $USE_ORCHESTRATED_MR_NOTE != "true"
  image: nikadwang.azurecr.io/copilot-runner:v0.0.5
  script:
    - copilot --version
    - export REPO_DIR="repo-${TARGET_PROJECT_ID}"
    - bash scripts/mr_update.sh
  artifacts:
    paths:
      - repo-*/patch_raw.txt

# Job for MR note orchestrated workflow (multi-stage with project understanding)
mr_note_orchestrated:
  stage: implement
  tags:
    - k8s
    - copilot
  rules:
    - if: $TRIGGER_TYPE == "mr_note" && $USE_ORCHESTRATED_MR_NOTE == "true"
  image: nikadwang.azurecr.io/copilot-runner:v0.0.5
  # Note: AZURE_STORAGE_CONNECTION_STRING is passed from webhook trigger
  script:
    - copilot --version
    - export REPO_DIR="repo-${TARGET_PROJECT_ID}"
    - bash scripts/mr_note_orchestrated.sh

# Job for MR review via @mention (e.g., "@copilot review this code")
mr_review_note:
  stage: implement
  tags:
    - k8s
    - copilot
  rules:
    - if: $TRIGGER_TYPE == "mr_review_note"
  image: nikadwang.azurecr.io/copilot-runner:v0.0.5
  # Note: Uses same workflow as mr_reviewer but triggered via @mention
  script:
    - copilot --version
    - export REPO_DIR="repo-${TARGET_PROJECT_ID}"
    - bash scripts/mr_review_orchestrated.sh
  artifacts:
    when: always
    paths:
      - task_plan.json
      - review_results.json
      - review_plan.json
      - review_summary.md
      - inline_comments.json
      - full_diff.txt
      - context_manager.log
      - project_analysis.log
      - repo-*/.copilot/
      - repo-*/.review_tasks/

# Job for MR reviewer workflow
mr_review:
  stage: implement
  tags:
    - k8s
    - copilot
  rules:
    - if: $TRIGGER_TYPE == "mr_reviewer"
  image: nikadwang.azurecr.io/copilot-runner:v0.0.5
  # Note: AZURE_STORAGE_CONNECTION_STRING is passed from webhook trigger
  script:
    - copilot --version
    - |
      # 使用项目ID作为目录名（避免不同项目冲突）
      REPO_DIR="repo-${TARGET_PROJECT_ID}"
      echo "[INFO] Using repository directory: ${REPO_DIR}"
      
      # 运行项目理解分析（如果启用）
      if [ "${ENABLE_PROJECT_UNDERSTANDING}" = "true" ]; then
        echo "[INFO] Running project understanding analysis on target repo..."
        
        # 调试：打印关键变量
        echo "[DEBUG] UPSTREAM_PROJECT_PATH: ${UPSTREAM_PROJECT_PATH}"
        echo "[DEBUG] UPSTREAM_GITLAB_BASE_URL: ${UPSTREAM_GITLAB_BASE_URL}"
        echo "[DEBUG] TARGET_PROJECT_ID: ${TARGET_PROJECT_ID}"
        echo "[DEBUG] TARGET_BRANCH: ${TARGET_BRANCH}"
        
        # 检查必要变量
        if [ -z "${UPSTREAM_PROJECT_PATH}" ]; then
          echo "[ERROR] UPSTREAM_PROJECT_PATH is not set, skipping project understanding"
          export ENABLE_PROJECT_UNDERSTANDING=false
        else
          # 克隆目标仓库到项目特定目录
          # 使用 GITLAB_TOKEN（webhook 传递的标准 token）
          # URL encode token 以处理特殊字符
          ENCODED_TOKEN=$(python3 -c "import urllib.parse; print(urllib.parse.quote('${GITLAB_TOKEN}', safe=''))")
          CLONE_URL="https://oauth2:${ENCODED_TOKEN}@${UPSTREAM_GITLAB_BASE_URL#https://}/${UPSTREAM_PROJECT_PATH}.git"
          echo "[INFO] Cloning from: https://oauth2:***@${UPSTREAM_GITLAB_BASE_URL#https://}/${UPSTREAM_PROJECT_PATH}.git"
          
          git clone "${CLONE_URL}" "${REPO_DIR}" || {
            echo "[ERROR] Failed to clone repository, skipping project understanding"
            export ENABLE_PROJECT_UNDERSTANDING=false
          }
        fi
      fi
      
      # 如果克隆成功，继续项目理解分析
      if [ "${ENABLE_PROJECT_UNDERSTANDING}" = "true" ] && [ -d "${REPO_DIR}" ]; then
        cd "${REPO_DIR}"
        export CI_COMMIT_SHA=$(git rev-parse HEAD)
        export CI_COMMIT_BEFORE_SHA=$(git rev-parse HEAD~1 2>/dev/null || echo "0000000000000000000000000000000000000000")
        git checkout "${TARGET_BRANCH:-main}" 2>/dev/null || echo "[WARN] Could not checkout ${TARGET_BRANCH:-main}"
        cd ..
        
        # 使用新的智能上下文管理器（Phase 6 集成）
        # 注意：必须在主仓库根目录运行，Copilot CLI 认证与当前 git 仓库绑定
        if [ -n "${AZURE_STORAGE_CONNECTION_STRING}" ]; then
          echo "[INFO] Using intelligent context manager with 5-level cache strategy..."
          echo "[DEBUG] AZURE_STORAGE_CONNECTION_STRING is set (length: ${#AZURE_STORAGE_CONNECTION_STRING})"
          bash scripts/ci_context_manager.sh || {
            echo "[WARN] Context manager failed, falling back to legacy mode"
            
            # Fallback: 在根目录运行（不要 cd 到 index_repo/src）
            export PYTHONPATH="${PWD}/index_repo/src:${PYTHONPATH:-}"
            echo "[INFO] Running project_understanding.cli in fallback mode..."
            # 注意：--output-dir 是相对于 workspace 的路径，所以用 .copilot 而不是 ${REPO_DIR}/.copilot
            python3 -m project_understanding.cli "${REPO_DIR}" --output-dir ".copilot" --output-file project_context.md --no-cache --timeout 3600 -v || echo "[WARN] Project understanding failed, continuing..."
            
            # 检查 .copilot 目录是否存在
            echo "[DEBUG] Checking ${REPO_DIR}/.copilot directory..."
            ls -la "${REPO_DIR}/.copilot" 2>/dev/null || echo "[DEBUG] .copilot directory does not exist or is empty"
            
            # Fallback 模式也需要上传到 Azure
            if [ -d "${REPO_DIR}/.copilot" ] && [ -n "${AZURE_STORAGE_CONNECTION_STRING}" ]; then
              echo "[INFO] Uploading context to Azure Blob Storage (fallback mode)..."
              # 使用环境变量传递连接字符串，避免 shell 转义问题
              python3 scripts/blob_cache.py upload \
                --project-id "${TARGET_PROJECT_ID}" \
                --branch "${TARGET_BRANCH}" \
                --commit "$(cd ${REPO_DIR} && git rev-parse HEAD)" \
                --parent-commit "$(cd ${REPO_DIR} && git rev-parse HEAD~1 2>/dev/null || echo '0000000000000000000000000000000000000000')" \
                --local-dir "${REPO_DIR}/.copilot" || echo "[WARN] Failed to upload context to Azure"
            else
              echo "[DEBUG] Skipping upload: .copilot exists=$([ -d "${REPO_DIR}/.copilot" ] && echo yes || echo no), AZURE_STORAGE_CONNECTION_STRING set=$([ -n "${AZURE_STORAGE_CONNECTION_STRING}" ] && echo yes || echo no)"
            fi
          }
        else
          # 无 Azure 连接时，直接执行完整分析
          echo "[INFO] Azure Blob Storage not configured, running full analysis..."
          export PYTHONPATH="${PWD}/index_repo/src:${PYTHONPATH:-}"
          # 注意：--output-dir 是相对于 workspace 的路径
          python3 -m project_understanding.cli "${REPO_DIR}" --output-dir ".copilot" --output-file project_context.md --no-cache --timeout 3600 -v || echo "[WARN] Project understanding failed, continuing..."
        fi
        
        echo "[INFO] Project understanding completed for ${REPO_DIR}"
      fi
      
      # 传递目录名给 review 脚本
      export REPO_DIR="${REPO_DIR}"
      export SKIP_REPO_CLONE="${ENABLE_PROJECT_UNDERSTANDING}"
      

      
      # 执行 MR review
      if [ "${USE_ORCHESTRATED_REVIEW:-false}" = "true" ]; then
        echo "[INFO] Using orchestrated review mode (task framework)"
        bash scripts/mr_review_orchestrated.sh
      elif [ "${ENABLE_INLINE_REVIEW_COMMENTS:-false}" = "true" ]; then
        echo "[INFO] Using inline comments mode"
        bash scripts/mr_review_with_inline_comments.sh
      else
        echo "[INFO] Using general comments mode"
        bash scripts/mr_review.sh
      fi
  artifacts:
    when: always
    paths:
      - task_plan.json
      - review_results.json
      - review_summary.md
      - full_diff.txt
      - review_comment.txt
      - context_manager.log
      - project_analysis.log
      - repo-*/task_plan.json
      - repo-*/review_results.json
      - repo-*/review_summary.md
      - repo-*/full_diff.txt
      - repo-*/review_comment.txt
      - repo-*/review_raw.txt
      - repo-*/review_summary.txt
      - repo-*/review_findings.json
      - repo-*/.copilot/
      - repo-*/.review_tasks/
