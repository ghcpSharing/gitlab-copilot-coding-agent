variables:
  UPSTREAM_GITLAB_BASE_URL: "https://gitlab.com"

workflow:
  rules:
    - if: $CI_PIPELINE_SOURCE == "trigger"
    - if: $CI_PIPELINE_SOURCE == "pipeline"
    - when: never

stages:
  - implement
  - test

# 测试 project_understanding 模块（通过 TRIGGER_TYPE 触发）
test_project_understanding:
  stage: test
  tags:
    - k8s
    - copilot
  rules:
    - if: $TRIGGER_TYPE == "test_project_understanding"
  image: satomic/copilot-cli:latest
  script:
    - copilot --version
    - cd index_repo/src
    - python -m project_understanding.cli --no-cache -v
    - cat .copilot/context.md
  artifacts:
    paths:
      - index_repo/src/.copilot/

# Job for issue assignee workflow (optimized single job)
issue_workflow:
  stage: implement
  tags:
    - k8s
    - copilot
  rules:
    - if: $TRIGGER_TYPE == "issue_assignee"
  image: satomic/copilot-cli:latest
  script:
    - copilot --version
    - export REPO_DIR="repo-${TARGET_PROJECT_ID}"
    - bash scripts/issue_workflow.sh
  artifacts:
    paths:
      - todo.md
      - todo_completed.md
      - mr.json
      - repo-*/todo_completed.md
      - repo-*/patch_raw.txt
      - repo-*/copilot.patch

# Job for MR note workflow
mr_update:
  stage: implement
  tags:
    - k8s
    - copilot
  rules:
    - if: $TRIGGER_TYPE == "mr_note"
  image: satomic/copilot-cli:latest
  script:
    - copilot --version
    - export REPO_DIR="repo-${TARGET_PROJECT_ID}"
    - bash scripts/mr_update.sh
  artifacts:
    paths:
      - repo-*/patch_raw.txt

# Job for MR reviewer workflow
mr_review:
  stage: implement
  tags:
    - k8s
    - copilot
  rules:
    - if: $TRIGGER_TYPE == "mr_reviewer"
  image: satomic/copilot-cli:latest
  variables:
    ENABLE_PROJECT_UNDERSTANDING: "${ENABLE_PROJECT_UNDERSTANDING:-false}"
    AZURE_STORAGE_CONNECTION_STRING: "${AZURE_STORAGE_CONNECTION_STRING}"
  script:
    - copilot --version
    - |
      # 使用项目ID作为目录名（避免不同项目冲突）
      REPO_DIR="repo-${TARGET_PROJECT_ID}"
      echo "[INFO] Using repository directory: ${REPO_DIR}"
      
      # 运行项目理解分析（如果启用）
      if [ "${ENABLE_PROJECT_UNDERSTANDING}" = "true" ]; then
        echo "[INFO] Running project understanding analysis on target repo..."
        
        # 克隆目标仓库到项目特定目录
        git clone "https://oauth2:${UPSTREAM_GITLAB_TOKEN}@${UPSTREAM_GITLAB_BASE_URL#https://}/${UPSTREAM_PROJECT_PATH}.git" "${REPO_DIR}"
        cd "${REPO_DIR}"
        CURRENT_COMMIT=$(git rev-parse HEAD)
        git checkout "${TARGET_BRANCH:-main}"
        cd ..
        
        # 尝试从 Azure Blob Storage 下载缓存
        if [ -n "${AZURE_STORAGE_CONNECTION_STRING}" ]; then
          echo "[INFO] Checking Azure Blob Storage cache..."
          python3 scripts/blob_cache.py download \
            --connection-string "${AZURE_STORAGE_CONNECTION_STRING}" \
            --project-id "${TARGET_PROJECT_ID}" \
            --branch "${TARGET_BRANCH:-main}" \
            --commit "${CURRENT_COMMIT}" \
            --local-dir "${REPO_DIR}/.copilot" && {
            echo "[INFO] Using cached project context from Azure Blob Storage"
            export SKIP_PROJECT_ANALYSIS=true
          } || echo "[INFO] No cache found, will generate new context"
        fi
        
        # 如果没有缓存，运行项目理解分析
        if [ "${SKIP_PROJECT_ANALYSIS}" != "true" ]; then
          cd index_repo/src
          python3 -m project_understanding.cli "../../${REPO_DIR}" --output-dir "../../${REPO_DIR}/.copilot" --output-file project_context.md --no-cache --timeout 3600 -v || echo "[WARN] Project understanding failed, continuing..."
          cd ../..
          
          # 上传到 Azure Blob Storage
          if [ -n "${AZURE_STORAGE_CONNECTION_STRING}" ] && [ -d "${REPO_DIR}/.copilot" ]; then
            echo "[INFO] Uploading project context to Azure Blob Storage..."
            python3 scripts/blob_cache.py upload \
              --connection-string "${AZURE_STORAGE_CONNECTION_STRING}" \
              --project-id "${TARGET_PROJECT_ID}" \
              --branch "${TARGET_BRANCH:-main}" \
              --commit "${CURRENT_COMMIT}" \
              --local-dir "${REPO_DIR}/.copilot" || echo "[WARN] Failed to upload cache"
          fi
        fi
        
        echo "[INFO] Project understanding completed for ${REPO_DIR}"
      fi
      
      # 传递目录名给 review 脚本
      export REPO_DIR="${REPO_DIR}"
      export SKIP_REPO_CLONE="${ENABLE_PROJECT_UNDERSTANDING}"
      

      
      # 执行 MR review
      if [ "${USE_ORCHESTRATED_REVIEW:-false}" = "true" ]; then
        echo "[INFO] Using orchestrated review mode (task framework)"
        bash scripts/mr_review_orchestrated.sh
      elif [ "${ENABLE_INLINE_REVIEW_COMMENTS:-false}" = "true" ]; then
        echo "[INFO] Using inline comments mode"
        bash scripts/mr_review_with_inline_comments.sh
      else
        echo "[INFO] Using general comments mode"
        bash scripts/mr_review.sh
      fi
  artifacts:
    when: always
    paths:
      - repo-*/task_plan.json
      - repo-*/review_results.json
      - repo-*/review_summary.md
      - repo-*/full_diff.txt
      - repo-*/review_comment.txt
      - repo-*/review_raw.txt
      - repo-*/review_summary.txt
      - repo-*/review_findings.json
      - repo-*/.copilot/
