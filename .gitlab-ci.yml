variables:
  UPSTREAM_GITLAB_BASE_URL: "https://gitlab.com"

workflow:
  rules:
    - if: $CI_PIPELINE_SOURCE == "trigger"
    - if: $CI_PIPELINE_SOURCE == "pipeline"
    - when: never

stages:
  - implement
  - test

# 测试 project_understanding 模块（仅在 multi-agents 分支手动触发）
test_project_understanding:
  stage: test
  tags:
    - k8s
    - copilot
  rules:
    - if: $CI_COMMIT_BRANCH == "multi-agents"
      when: manual
    - if: $TRIGGER_TYPE == "test_project_understanding"
  image: satomic/copilot-cli:latest
  script:
    - copilot --version
    - cd index_repo/src
    - python -m project_understanding.cli --no-cache -v
    - cat .copilot/context.md
  artifacts:
    paths:
      - index_repo/src/.copilot/

# Job for issue assignee workflow (optimized single job)
issue_workflow:
  stage: implement
  tags:
    - k8s
    - copilot
  rules:
    - if: $TRIGGER_TYPE == "issue_assignee"
  image: satomic/copilot-cli:latest
  script:
    - copilot --version
    - bash scripts/issue_workflow.sh
  artifacts:
    paths:
      - todo.md
      - todo_completed.md
      - mr.json
      - repo-b/todo_completed.md
      - repo-b/patch_raw.txt
      - repo-b/copilot.patch

# Job for MR note workflow
mr_update:
  stage: implement
  tags:
    - k8s
    - copilot
  rules:
    - if: $TRIGGER_TYPE == "mr_note"
  image: satomic/copilot-cli:latest
  script:
    - copilot --version
    - bash scripts/mr_update.sh
  artifacts:
    paths:
      - repo-b/patch_raw.txt

# Job for MR reviewer workflow
mr_review:
  stage: implement
  tags:
    - k8s
    - copilot
  rules:
    - if: $TRIGGER_TYPE == "mr_reviewer"
  image: satomic/copilot-cli:latest
  script:
    - copilot --version
    - |
      if [ "${USE_ORCHESTRATED_REVIEW:-false}" = "true" ]; then
        echo "[INFO] Using orchestrated review mode (task framework)"
        bash scripts/mr_review_orchestrated.sh
      elif [ "${ENABLE_INLINE_REVIEW_COMMENTS:-false}" = "true" ]; then
        echo "[INFO] Using inline comments mode"
        bash scripts/mr_review_with_inline_comments.sh
      else
        echo "[INFO] Using general comments mode"
        bash scripts/mr_review.sh
      fi
  artifacts:
    paths:
      - repo-b/review_raw.txt
      - repo-b/review_summary.txt
      - repo-b/review_findings.json
      - repo-b/task_plan.json
      - repo-b/review_results.json
      - repo-b/review_summary.md
      - repo-b/review_comment.txt
