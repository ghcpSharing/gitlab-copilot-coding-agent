# GitLab CI Runner Image with Copilot CLI and Azure Blob Storage support
# Based on Node.js 22 (required by Copilot CLI)

FROM node:22-slim

# Install Copilot CLI globally
# See: https://github.com/github/copilot-cli
RUN npm install -g @github/copilot

# Install Python 3 and pip for project understanding scripts
RUN apt-get update && apt-get install -y --no-install-recommends \
    python3 \
    python3-pip \
    python3-venv \
    git \
    curl \
    && rm -rf /var/lib/apt/lists/*

# Create symlinks for python
RUN ln -sf /usr/bin/python3 /usr/bin/python

# Install Python packages required for project understanding and blob cache
RUN pip install --no-cache-dir --break-system-packages \
    azure-storage-blob \
    tiktoken \
    pathspec

# Verify installations
RUN copilot --version
RUN python3 -c "from azure.storage.blob import BlobServiceClient; print('âœ… azure-storage-blob installed')"

# Set working directory
WORKDIR /builds

# Default command
CMD ["/bin/bash"]
